<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Transparency Map - SG Track</title>
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body,
        html {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #publicMap {
            height: 100%;
            width: 100%;
            z-index: 10;
        }

        .map-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: var(--color-surface);
            padding: 1rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            width: 250px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <nav class="navbar" style="flex-shrink: 0;">
        <div class="container">
            <a href="index.html" class="nav-brand">
                <img src="logo.svg" alt="Logo" class="nav-brand-logo">
                SG Track Map
            </a>
            <div class="nav-links" id="navLinks">
                <a href="index.html" id="backLink">Back</a>
                <a href="index.html" class="btn btn-primary" style="color:#fff;" id="loginReportBtn">Login / Report</a>
            </div>
        </div>
    </nav>

    <div class="map-container">
        <div id="publicMap"></div>

        <div class="map-overlay">
            <h4 style="margin-bottom: 1rem;">Map Filters</h4>

            <div style="margin-bottom: 1rem;">
                <label
                    style="font-size: 0.8rem; font-weight: 500; color: var(--color-text-muted); display: block; margin-bottom: 0.25rem;">Department</label>
                <select id="filterCategory" class="form-select" style="font-size: 0.8rem; padding: 0.4rem;">
                    <option value="All">All Departments</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Water">Water / Plumbing</option>
                    <option value="Roads">Roads / Potholes</option>
                    <option value="Waste">Waste / Garbage</option>
                    <option value="General">General / Other</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="font-size: 0.8rem; font-weight: 500; color: var(--color-text-muted); display: block; margin-bottom: 0.25rem;">Status</label>
                <select id="filterStatus" class="form-select" style="font-size: 0.8rem; padding: 0.4rem;">
                    <option value="All">All Statuses</option>
                    <option value="PENDING">Pending Review</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="RESOLVED">Resolved</option>
                </select>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                <h5 style="margin-bottom: 0.5rem; font-size: 0.85rem;">Legend</h5>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--status-pending);"></div>
                    <span>Pending Review</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--status-progress);"></div>
                    <span>In Progress</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--status-resolved);"></div>
                    <span>Resolved</span>
                </div>
            </div>
        </div>
    </div>



    <script src="api.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = api.getUser();
            if (user) {
                const btn = document.getElementById('loginReportBtn');
                if (btn) btn.remove();

                const backLink = document.getElementById('backLink');
                if (backLink) {
                    backLink.href = user.role === 'official' ? 'department_dashboard.html' : 'citizen_dashboard.html';
                }
            }

            // Initialize map over Central India
            const map = L.map('publicMap').setView([22.5937, 78.9629], 5);

            // Standard realistic map tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Custom generic markers to differentiate status without neon
            const createIcon = (color) => {
                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
            };

            const icons = {
                PENDING: createIcon('#f59e0b'),
                IN_PROGRESS: createIcon('#3b82f6'),
                RESOLVED: createIcon('#10b981')
            };

            // Phase 5: Global UPVOTE logic for Leaflet Popups
            window.toggleUpvote = async (id, btnElement) => {
                if (!user) {
                    alert('You must be logged in to upvote issues.');
                    window.location.href = 'auth_citizen.html';
                    return;
                }

                // Optimistic UI update
                const span = btnElement.querySelector('span');
                let count = parseInt(span.textContent) || 0;
                btnElement.disabled = true;

                try {
                    const res = await api.fetchWithAuth(`/complaints/${id}/upvote`, { method: 'POST' });
                    span.textContent = res.upvotes;

                    // Toggle active state
                    if (res.upvotes > count) {
                        btnElement.style.color = 'var(--status-critical)';
                    } else {
                        btnElement.style.color = 'var(--color-text-muted)';
                    }
                } catch (err) {
                    alert('Failed to upvote: ' + err.message);
                } finally {
                    btnElement.disabled = false;
                }
            };

            try {
                let allGrievances = [];
                let activeMarkers = [];

                const filterCategory = document.getElementById('filterCategory');
                const filterStatus = document.getElementById('filterStatus');

                const renderMarkers = () => {
                    // Clear existing markers
                    activeMarkers.forEach(m => map.removeLayer(m));
                    activeMarkers = [];
                    const bounds = [];

                    const categoryVal = filterCategory.value;
                    const statusVal = filterStatus.value;

                    allGrievances.forEach(g => {
                        // Apply filters
                        if (categoryVal !== 'All' && g.category !== categoryVal) return;
                        if (statusVal !== 'All' && g.status !== statusVal) return;

                        if (g.location && g.location.coordinates) {
                            const lat = g.location.coordinates[1];
                            const lng = g.location.coordinates[0];

                            const colorConf = icons[g.status];
                            const marker = L.marker([lat, lng], { icon: colorConf || icons.PENDING }).addTo(map);

                            const upvotesCount = g.upvotes ? g.upvotes.length : 0;
                            const hasUpvoted = user && g.upvotes && g.upvotes.includes(user._id);
                            const heartColor = hasUpvoted ? 'var(--status-critical)' : 'var(--color-text-muted)';

                            const popupContent = `
                                <div style="font-family:Inter,sans-serif; min-width:160px; padding-bottom: 0.5rem;">
                                    <strong style="display:block; margin-bottom:4px; font-size: 0.95rem;">${g.title}</strong>
                                    <span style="font-size:0.75rem; color:#64748b; margin-bottom: 0.5rem; display: block;">${g.category} &bull; ${g.severity}</span>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e2e8f0; padding-top: 0.5rem; margin-top: 0.25rem;">
                                        <div style="font-weight:600; font-size:0.8rem; color: var(--status-${g.status === 'PENDING' ? 'pending' : g.status === 'IN_PROGRESS' ? 'progress' : 'resolved'})">${g.status.replace('_', ' ')}</div>
                                        
                                        <button onclick="toggleUpvote('${g._id}', this)" style="background:none; border:none; cursor:pointer; color:${heartColor}; display:flex; align-items:center; gap:0.25rem; font-size:0.85rem; padding: 0.25rem;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                            <span>${upvotesCount}</span>
                                        </button>
                                    </div>
                                </div>
                            `;

                            marker.bindPopup(popupContent);
                            activeMarkers.push(marker);
                            bounds.push([lat, lng]);
                        }
                    });

                    // Fit map bounds if points exist, otherwise just zoom out slightly
                    if (bounds.length > 0) {
                        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                    }
                };

                // Fetch public coordinates
                const res = await fetch('http://localhost:5000/api/complaints/public');
                allGrievances = await res.json();

                // Initial render
                renderMarkers();

                // Bind filter events
                filterCategory.addEventListener('change', renderMarkers);
                filterStatus.addEventListener('change', renderMarkers);

                // Fit map bounds to India data if points exist
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                }

            } catch (err) {
                console.error('Failed to load map data', err);
            }
        });
    </script>
</body>

</html>